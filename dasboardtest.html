<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard WMS</title>

<link rel="stylesheet" href="https://fab-404.github.io/Path/stylev2.css" />
</head>

<body>

<div class="top-bar">
  <div class="top-bar-left">
    <!-- RÃ©sumÃ© bases -->
    <div id="bases-summary" class="bases-summary"></div>
  </div>
</div>


<div class="slider-container">
  <div class="pages-wrapper" id="pages-wrapper"></div>
</div>

<!-- <div class="bottom-bar">Â© WMS</div> -->

<button id="config-toggle-btn" title="Afficher / Masquer la configuration">âš™ Config</button>

<div id="config-panel">
  <label for="grids-per-page">Nombre de grilles (blocs) :</label>
  <input type="number" id="grids-per-page" min="1" max="10" value="4" />

  <label for="badges-list">Liste des badges (sÃ©parÃ©s par virgules) :</label>
  <input type="text" id="badges-list" placeholder="ex: 0001,0002,0003" />

  <button id="config-save-btn">Sauvegarder</button>
  <div id="save-status">Configuration sauvegardÃ©e !</div>
</div>

<script>
/* ===============================
   INIT DASHBOARD
=============================== */

console.log('[Dashboard] page chargÃ©e');

const MISSIONS_STORAGE_KEY = 'wmsDashboardMissions';
window.missionsData = [];

/* ===== Fallback localStorage (au chargement uniquement) ===== */
(function loadFromStorageOnce() {
  try {
    const stored = localStorage.getItem(MISSIONS_STORAGE_KEY);
    if (stored) {
      window.missionsData = JSON.parse(stored);
      console.log('[Dashboard] missions chargÃ©es depuis localStorage:', window.missionsData.length);
    }
  } catch (e) {
    console.error('[Dashboard] erreur lecture localStorage', e);
  }
})();

/* ===== RÃ©ception des donnÃ©es depuis WMS ===== */
window.addEventListener('message', (event) => {
  if (event.data?.type !== 'missionsData') return;

  window.missionsData = Array.isArray(event.data.payload)
    ? event.data.payload
    : [];

  console.log('[Dashboard] missions reÃ§ues:', window.missionsData.length);

  try {
    localStorage.setItem(
      MISSIONS_STORAGE_KEY,
      JSON.stringify(window.missionsData)
    );
  } catch (e) {
    console.error('[Dashboard] erreur sauvegarde localStorage', e);
  }

  if (typeof window.renderDashboard === 'function') {
    window.renderDashboard(window.missionsData);
  }
});

/* ===== Handshake : dashboard prÃªt ===== */
window.opener?.postMessage({ type: 'dashboardReady' }, '*');
console.log('[Dashboard] dashboardReady envoyÃ©');

/* ===== Debug log toutes les 30 sec sans reload ===== */
setInterval(() => {
  const now = new Date();
  const timeString = now.toLocaleTimeString();
  console.log(`[${timeString}] [Dashboard] debug - tick 30s`);
}, 30000);


/* =========================
   BASES â€“ RENDER
========================= */

function renderBasesSummary(stats) {
  const container = document.getElementById('bases-summary');
  if (!container || !stats) return;

  container.innerHTML = '';

  Object.entries(stats).forEach(([base, d]) => {
    const bubble = document.createElement('div');
    bubble.className = 'base-bubble';

    bubble.innerHTML = `
      <div class="base-name">${base}</div>
      <div class="base-percent">${d.percent}%</div>
      <div class="base-line">${d.termine} / ${d.total} &nbsp; RAF : ${d.raf}</div>
    `;

    container.appendChild(bubble);
  });
}

/* =========================
   SOURCE DONNÃ‰ES (TEMP)
========================= */

// ðŸ‘‰ Simulation locale (Ã  remplacer plus tard)
const MOCK_STATS = {
  "60BEZ": { total: 120, termine: 90, raf: 30, percent: 75 },
  "61ANG": { total: 80, termine: 50, raf: 30, percent: 62.5 },
  "60MON": { total: 60, termine: 60, raf: 0, percent: 100 },
  "60CAS": { total: 40, termine: 10, raf: 30, percent: 25 },
  "60ANG": { total: 100, termine: 20, raf: 80, percent: 20 }
};

// rendu initial
renderBasesSummary(MOCK_STATS);

  
</script>
  
<!-- Scripts fonctionnels -->
<script src="https://fab-404.github.io/Path/wms-dashboard-render.js"></script>
<script src="https://fab-404.github.io/Path/script-config.js"></script>

</body>
</html>
