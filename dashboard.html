<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Dashboard WMS</title>

<!-- <link rel="stylesheet" href="https://fab-404.github.io/Path/style.css" /> -->
<link rel="stylesheet" href="https://fab-404.github.io/Path/stylev.css" />
</head>

<body>

<div class="top-bar">
  <div class="top-bar-left"><span class="logo">WMS</span></div>
</div>

<div class="slider-container">
  <div class="pages-wrapper" id="pages-wrapper"></div>
</div>

<div class="bottom-bar">© WMS</div>

<!-- Bouton config -->
<button id="config-toggle-btn" title="Afficher / Masquer la configuration">⚙ Config</button>

<!-- Panneau config -->
<div id="config-panel">
  <label for="grids-per-page">Nombre de grilles (blocs) :</label>
  <input type="number" id="grids-per-page" min="1" max="10" value="4" />

  <label for="badges-list">Liste des badges (séparés par virgules) :</label>
  <input type="text" id="badges-list" placeholder="ex: 0001,0002,0003" />

  <button id="config-save-btn">Sauvegarder</button>
  <div id="save-status">Configuration sauvegardée !</div>
</div>

<script>
/* ===============================
   INIT DASHBOARD
=============================== */

console.log('[Dashboard] page chargée');

// Stockage global des missions
window.missionsData = [];

// Clé de stockage local pour les missions
const MISSIONS_STORAGE_KEY = 'wmsDashboardMissions';

// Fonction pour charger missions depuis localStorage et rendre dashboard
function loadAndRenderFromStorage() {
  try {
    const stored = localStorage.getItem(MISSIONS_STORAGE_KEY);
    if (stored) {
      window.missionsData = JSON.parse(stored);
      console.log('[Dashboard] missions chargées depuis localStorage:', window.missionsData.length);
    } else {
      window.missionsData = [];
      console.log('[Dashboard] aucune mission en localStorage');
    }
  } catch(e) {
    window.missionsData = [];
    console.error('[Dashboard] erreur lecture missions localStorage', e);
  }
  if (typeof window.renderDashboard === 'function') {
    window.renderDashboard(window.missionsData);
  } else {
    console.error('[Dashboard] renderDashboard non disponible');
  }
}

// Rafraîchir données toutes les 5 minutes
setInterval(() => {
  console.log('[Dashboard] rafraîchissement automatique des données');
  loadAndRenderFromStorage();
}, 1 * 60 * 1000);

// Réception des données depuis Tampermonkey (postMessage)
window.addEventListener('message', (event) => {
  if (!event.data || event.data.type !== 'missionsData') {
    return;
  }
  console.log('[Dashboard] message reçu:', event.data);
  window.missionsData = Array.isArray(event.data.payload) ? event.data.payload : [];
  console.log('[Dashboard] missions reçues via postMessage:', window.missionsData.length);

  // Sauvegarder dans localStorage à chaque réception
  try {
    localStorage.setItem(MISSIONS_STORAGE_KEY, JSON.stringify(window.missionsData));
  } catch(e) {
    console.error('[Dashboard] erreur sauvegarde missions localStorage', e);
  }

  if (typeof window.renderDashboard === 'function') {
    window.renderDashboard(window.missionsData);
  } else {
    console.error('[Dashboard] renderDashboard non disponible');
  }
}, false);

// Chargement initial des données au démarrage
loadAndRenderFromStorage();

/* ===============================
   DEBUG CONFIG
=============================== */

const STORAGE_KEY = 'wmsDashboardConfig';

try {
  const stored = localStorage.getItem(STORAGE_KEY);
  if (stored) {
    console.log('[Dashboard] config chargée:', JSON.parse(stored));
  } else {
    console.log('[Dashboard] aucune config trouvée (valeurs par défaut)');
  }
} catch (e) {
  console.error('[Dashboard] erreur lecture localStorage', e);
}
</script>

<!-- Scripts fonctionnels -->
<!--<script src="https://fab-404.github.io/Path/script-slider.js"></script>-->
<script src="https://fab-404.github.io/Path/wms-dashboard-render.js"></script>
<script src="https://fab-404.github.io/Path/script-config.js"></script>
 

</body>
</html>
